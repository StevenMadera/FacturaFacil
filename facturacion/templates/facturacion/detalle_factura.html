{% extends 'facturacion/base_facturacion.html' %}

{% block facturacion_content %}
<div class="container my-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">Factura Electrónica #{{ factura.numero }}</h3>
            <div class="float-end d-flex gap-2">
                <a href="{% url 'facturacion:factura_pdf' factura.pk %}" class="btn btn-light btn-sm" target="_blank">
                    <i class="fas fa-file-pdf"></i> Descargar PDF
                </a>
                <button type="button" class="btn btn-outline-light btn-sm" onclick="mostrarModalCorreo()">
                    <i class="fas fa-envelope"></i> Enviar por correo
                </button>
                <div id="mensajeExito" class="alert alert-success py-1 px-2 mb-0 ms-2 d-none" style="font-size:0.95em;">¡Correo enviado con éxito!</div>
            </div>
        </div>
        <div class="card-body">

<!-- Modal para enviar correo -->
<div class="modal fade" id="modalCorreo" tabindex="-1" aria-labelledby="modalCorreoLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="formCorreo" onsubmit="enviarCorreo(event)">
        <div class="modal-header">
          <h5 class="modal-title" id="modalCorreoLabel">Enviar factura por correo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <input type="email" class="form-control" id="correoDestino" placeholder="Correo destinatario" required autofocus>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Enviar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function mostrarModalCorreo() {
    var modal = new bootstrap.Modal(document.getElementById('modalCorreo'));
    modal.show();
}
function enviarCorreo(e) {
    e.preventDefault();
    var modal = bootstrap.Modal.getInstance(document.getElementById('modalCorreo'));
    modal.hide();
    
    fetch('{% url "facturacion:marcar_factura_enviada" factura.pk %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Accept': 'application/json',
        },
    }).then(function(resp) { return resp.json(); })
    .then(function(data) {
        if (data.ok) {
            document.getElementById('mensajeExito').classList.remove('d-none');
            
            var estadoHtml = '<span class="badge bg-info text-dark">Enviada</span>';
            var estadoContainer = document.querySelector('.col-md-6.text-end');
            if (estadoContainer) {
                var html = estadoContainer.innerHTML;
                html = html.replace(/<span class=\"badge bg-primary\">Emitida<\/span>/, estadoHtml);
                html = html.replace(/<span class=\"badge bg-secondary\">Borrador<\/span>/, estadoHtml);
                if (!html.includes('Enviada')) {
                    html = html.replace('Estado:</strong>', 'Estado:</strong> ' + estadoHtml);
                }
                
                html = html.replace(/<span class=\"badge bg-warning text-dark ms-1\">Pendiente<\/span>/, '');
                estadoContainer.innerHTML = html;
            }
        }
        setTimeout(function() {
            document.getElementById('mensajeExito').classList.add('d-none');
            document.getElementById('formCorreo').reset();
        }, 2000);
    });
}


function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
            <div class="row mb-3">
                <div class="col-md-6">
                    <strong>Cliente:</strong> {{ factura.cliente.nombre }}<br>
                    <strong>Dirección:</strong> {{ factura.cliente.direccion }}<br>
                    <strong>Correo:</strong> {{ factura.cliente.email }}<br>
                    <strong>Teléfono:</strong> {{ factura.cliente.telefono }}<br>
                </div>
                <div class="col-md-6 text-end">
                    <strong>Fecha de emisión:</strong> {{ factura.fecha|date:"d/m/Y" }}<br>
                    <strong>Estado:</strong>
                    {% if factura.estado == 'enviada' %}
                        <span class="badge bg-info text-dark">Enviada</span>
                    {% elif factura.estado == 'emitida' %}
                        <span class="badge bg-primary">Emitida</span>
                    {% else %}
                        <span class="badge bg-secondary">Borrador</span>
                    {% endif %}
                    {% if factura.pagada %}
                        <span class="badge bg-success ms-1">Pagada</span>
                    {% endif %}<br>
                </div>
            </div>
            <hr>
            <h5>Detalle de productos/servicios</h5>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio Unitario</th>
                            <th>Impuesto (%)</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for d in detalles %}
                        <tr>
                            <td>{{ d.producto.nombre }}</td>
                            <td>{{ d.cantidad }}</td>
                            <td>${{ d.precio_unitario|floatformat:2 }}</td>
                            <td>{{ d.impuesto|floatformat:2 }}%</td>
                            <td>${{ d.subtotal|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="row justify-content-end">
                <div class="col-md-4">
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Subtotal</span>
                            <span>${{ factura.subtotal|floatformat:2 }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Impuestos</span>
                            <span>${{ factura.impuestos|floatformat:2 }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center fw-bold">
                            <span>Total</span>
                            <span>${{ factura.total|floatformat:2 }}</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="mt-3">
        <a href="{% url 'facturacion:lista_facturas' %}" class="btn btn-secondary">Volver a la lista</a>
    </div>
</div>
{% endblock %}
